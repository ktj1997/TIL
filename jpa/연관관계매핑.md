# 연관관계 매핑
**패러다임의문제**<br>
DB는 FK를 이용해서 연관된 데이터를 가져오고, 객체는 참조를 통해가져옴<br>
DB에 맞게 fk를 이용해서 엔티티를 작성한다면, 참조를 사용하지 못함으로, 연관된 데이터의정보를 JPA에게 계속물어봐야함<br>
***
## 용어
1. **방향**: 단방향(한객체 에서만 다른 객체 참조) vs 양방향(두 객체가 서로를 참조)
2. **다중성** : 다대일(N:1), 일대다(1:N), 일대일(1:1),다대다(N:M)
3. **관계의주인**: 연관관계를 전체적으로 관리하는 주인(key값을 가지는 엔티티), 주인이 아닌 엔티티는 읽기만 가능 
***

## 단방향
```
@Entity
@Getter
@NoArgsConstructor
public class Member{
    @Id
    @GeneratedValue
    private Long id;

    @Column(length = 20,nullable = false)
    private String userName;

    @ManyToOne
    @JoinColumn(name="team_id")
    private Team team;
}

@Entity
@Getter
@NoArgsConstructor
public class Team{
    @Id
    @GeneratedValue
    private Long id;

    @Column(length=20,nullable = false)
    private String name;
}
```
1. **Member(N) : Team(1) 단방향 관계**<br>
2. **@JoinColumn 생략시 : table_(@Id에노테이션을 갖는 Column명)으로 FK가 세팅**

***
## 양방향
```
@Entity
@Getter
@NoArgsConstructor
public class Member{
    @Id
    @GeneratedValue
    private Long id;

    @Column(length = 20,nullable = false)
    private String userName;

    @ManyToOne
    @JoinColumn(name="team_id")
    private Team team;
}

@Entity
@Getter
@NoArgsConstructor
public class Team{
    @Id
    @GeneratedValue
    private Long id;

    @Column(length=20,nullable = false)
    private String name;

    @OneToMany(mappedBy="team")
    List<Member> members = new ArrayList(); // NPE방지용 초기화 
}
```
1. DB에는 양방향이라는 개념이 없다. 어느쪽에서 Query를 시작하든 FK로 Join 하면 되기떄문<br>
2. 객체의 참조는 양방향이 아니라면 참조가 없는쪽은 연관관계를 갖는 객체를 불러 올 수 없다<br>
3. **JPA에서의 양방향은 단방향 + 단방향이다**(단방향으로 이미 매핑이 된 것)
4. 객체지향 관점에서 양쪽에 다 변경을 해주는 것이 맞다.
```java
    public void  update(Team team){
        member.setTeam(team);
        team.getMembers().add(this);
    }
```
5. 무한루프를 조심하자

***
## mappedBy
**객체를 통한 양방향 연관관계에서는 한 객체에서 연관관계를 관리해주어야한다**

1. 연관관계의 주인이 연관관계에대한 수정이 가능하다.
2. 주인이 아닌 객체는 읽기만 가능하다.
3. **주인은 mappedBy속성을 갖지않는다.(주인이 아닌쪽이 갖는다)**
4. **외래키가 있는곳을 주인으로 정하자**(외래키가 있는곳이 N)
5. 비지니스 상으로 중요해서 연관관계의 주인인 것은 아니다
6. **연관관계 주인에서 일어난 변경만 DB에 반영된다**