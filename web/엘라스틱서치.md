# 엘라스틱 서치

**JSON, REST 기반**

## 도커 설치

```shell
# 실습 1.7버전......
docker run -p 9200:9200 -p 9300:9300 -d --name=elastic1 elasticsearch:1.7
```

- 보통 9200번 포트 사용
- 접속시

```json
{
  "status": 200,
  "name": "Smasher",
  "cluster_name": "elasticsearch",
  "version": {
    "number": "1.7.6",
    "build_hash": "c730b59357f8ebc555286794dcd90b3411f517c9",
    "build_timestamp": "2016-11-18T15:21:16Z",
    "build_snapshot": false,
    "lucene_version": "4.10.4"
  },
  "tagline": "You Know, for Search"
}
```

## 용어

- **인덱스 (Index)** : 데이터베이스의 테이블(Table) / 카탈로그(Catalog)
- **타입 (Type)**: 데이터베이스의 테이블(Table)
- **도큐먼트 (Document)**: 데이터베이스의 레코드(Record) / 로우(Row)
- **필드 (Field)**: 데이터베이스의 칼럼(Column)
- **매핑 (Mapping)**: 데이터베이스의 스키마(Schema)
- **인덱싱 (Indexing)**: 자료를 빠르게 검색 하기위해 미리 준비된 정보
- **QueryDSL**:  SQL과 같은 질의어 (Java의 QueryDSL과 다르다)

## CRUD

### CREATE/UPDATE

#### PUT (식별자 지정해줘야함)

**Request**

```shell
curl -XPUT http://localhost:9200/books/book/1 -d'
    {
      "title":"ElasticSearch",
      "author":"kim",
      "date":"2021-11-30",
      "pages":"250"
    }'
```

**Response**

```shell
{
  "_index":"books",
  "_type":"book",
  "_id":"1",
  "_version":1,
  "created":true
}
```

- index/type/document를 만들거다.
- 아무것도 없는 상태에서 날려도 없는 것들이 함께 생긴다.
- id 지정 가능

#### POST (식별자 지정가능, 지정안하면 식별자 랜덤)

**Request**

```shell
curl -XPOST http://localhost:9200/books/book -d'
    {
      "title":"ElasticSearch",
      "author":"kim",
      "date":"2021-11-30",
      "pages":"250"
    }'
```

**Response**

```shell
{
  "_index":"books",
  "_type":"book",
  "_id":"AX2A-Bdgln0V2kuknwHF",
  "_version":1,
  "created":true
  }
```

_bulk를 통해서 다량의 데이터를 한번에 넣을 수 있다.

### READ(검색)

- URI 검색
- RequestBody검색
    - Json인자 전달
    - 길이제한 없고, 인자 노출(x)
    - 옵션이 다양

**Request**

1. 식별자로 검색

```shell
curl -XGET http://localhost:9200/books/book/1
```

**Response**

```shell
{
  "_index":"books",
  "_type":"book",
  "_id":"1",
  "_version":1,
  "found":true,
  "_source":{
      "title":"ElasticSearch",
      "author":"kim",
      "date":"2021-11-30",
      "pages":"250"
    }
}
```

2. 통합검색 (인덱스,도큐먼트,필드 등 조건을 안줘도 됨)

**Request**

```shell
curl -XGET http://localhost:9200/_search?q=time
```

```shell
curl -XGET http://localhost:9200/_all/_search?q=time
```

**Response**

```json
"hits": {
"total": 6,
"max_score": 0.18634011,
"hits": [
{
"_index": "books",
"_type": "book",
"_id": "AX2afALs4IXqtu_TL0UN",
"_score": 0.18634011,
"_source": {
"title": "Around the World in Eighty Days",
"author": "Jules Verne",
"category": "adventure novel",
"written": "1873-07-01T10:30:00",
"pages": 189,
"sell": 27200000,
"plot": "Fogg and Passepartout reach Suez in time. While disembarking in Egypt, they are watched by a Scotland Yard detective named Fix, who has been dispatched from London in search of a bank robber. Because Fogg matches the description of the robber, Fix mistakes Fogg for the criminal. Since he cannot secure a warrant in time, Fix boards the steamer conveying the travellers to Bombay. Fix becomes acquainted with Passepartout without revealing his purpose. Fogg promises the steamer engineer a large reward if he gets them to Bombay early. They dock two days ahead of schedule."
}
},
{
"_index": "books",
"_type": "book",
"_id": "AX2afALs4IXqtu_TL0UJ",
"_score": 0.16237976,
"_source": {
"title": "The Time Machine",
"author": "H. G. Wells",
"category": "Science fiction novel",
"written": "1895-11-01T05:01:00",
"pages": 227,
"sell": 22100000,
"plot": "The book's protagonist is an English scientist and gentleman inventor living in Richmond, Surrey in Victorian England, and identified by a narrator simply as the Time Traveller. The narrator recounts the Traveller's lecture to his weekly dinner guests that time is simply a fourth dimension, and his demonstration of a tabletop model machine for travelling through it. He reveals that he has built a machine capable of carrying a person, and returns at dinner the following week to recount a remarkable tale, becoming the new narrator."
}
}
```

- hit로 몇개를 검색조건에 맞게 찾았는지 알려준다.
- 내부로직(Lucene 내장)을 통해 나타나는 Score로 적합성을 나타내준다.
- Multi-Tenancy(멀티 테넌시) 라고한다. --> 엘라스틱에서는 범위없이 다 뒤지는걸 의미

3. 조건검색[Index] (books, magazines Index에서 쿼리검색)
   **Request**

```shell
curl -XGET http://localhost:9200/books,magazines/_search?q=time
```

4. 조건검색[Field]

**Request**

```shell
curl -XGET http://localhost:9200/_search?q=title:time
```

**Response**

```json

"took": 5,
"timed_out": false,
"_shards": {
"total": 10,
"successful": 10,
"failed": 0
},
"hits": {
"total": 2,
"max_score": 0.5,
"hits": [
{
"_index": "books",
"_type": "book",
"_id": "AX2afALs4IXqtu_TL0UJ",
"_score": 0.5,
"_source": {
"title": "The Time Machine",
"author": "H. G. Wells",
"category": "Science fiction novel",
"written": "1895-11-01T05:01:00",
"pages": 227,
"sell": 22100000,
"plot": "The book's protagonist is an English scientist and gentleman inventor living in Richmond, Surrey in Victorian England, and identified by a narrator simply as the Time Traveller. The narrator recounts the Traveller's lecture to his weekly dinner guests that time is simply a fourth dimension, and his demonstration of a tabletop model machine for travelling through it. He reveals that he has built a machine capable of carrying a person, and returns at dinner the following week to recount a remarkable tale, becoming the new narrator."
}
},
{
"_index": "magazines",
"_type": "magazine",
"_id": "AX2afYek4IXqtu_TL0UP",
"_score": 0.30685282,
"_source": {
"title": "Time",
"company": "Time Inc.",
"category": "News magazine",
"issue": "2014-03-01T00:00:00"
}
}
]
}
}
```

5. 연산자

- OR (뒤에 안지정해주면 default)

```shell
curl -XGET http://localhost:9200/_search?q=title+time
```

**title 공백 time 인데 URL상이므로 escape --> +**

- 기본 연산자

```shell
curl -XGET http://localhost:9200/_search?q=title+time&default_operator=AND
```

- 프로젝션(특정 필드만 출력)

```shell
curl -XGET http://localhost:9200/_search?q=title:time&fields=title
```

6. 정렬
   **default 정렬은 Score**

```shell
curl -XGET http://localhost:9200/_search?q=time&fields=title&sort=pages:desc
```

- **time이라는 검색어로 검색 하는데, title필드만 출력하고 page숫자가 많은순으로 내림차순으로 정렬 해달라**
- 기본적으로 Sort 조건을 바꾸면 Score는 null이 된다. (계산할 필요가 없으므로)
- 정렬 옵션을 바꾸면서 Score를 출력하고 싶으면 track_scores=true 옵션을 주면 된다.
#### 데이터만 가져오기

**Request**

```shell
curl -XGET http://localhost:9200/books/book/1/_source
```

**Response**

```shell
{
    "title":"ElasticSearch",
    "author":"kim",
    "date":"2021-11-30",
    "pages":"250"
}
```

- \_source는 data를 의미,
- index,type, 식별자, 버전,쿼리 성공여부 등을 리턴해준다.

### DELETE

**Request**

```shell
curl -XDELETE http://localhost:9200/books/book/1/
```

**Response**

```shell
{
  found":true,
  "_index":"books",
  "_type":"book",
  "_id":"1",
  "_version":5
}
```

- ***CRUD 모두 버전으로 관리된다***
- 삭제 된후 다시 Insert시 버전은 리셋된다.
- Column 단위의 Update도 가능하다. (_update 옵션)