# 쿠키 & 세션

HTTP의 Stateless한 특성을 보완하기위해서 나온 개념

## 쿠키 
- **서버가 사용자 웹브라우저(Client Local)에 남기는 데이터**
- key:value로 이루어진 문자열이다.
- 사용자가 서버에 요청을 보낼 때 브라우저는 요청과 함꼐 쿠키를 보낸다.
- 브라우저가 종료되도 남아있다.

### 동작과정
1. 클라이언트가 서버에 접속시 서버가 Cookie를 발급 (HTTP 헤더에 담아서 응답해준다.)
2. 클라이언트는 브라우저에 쿠키를 저장함 (브라우저가 다르면 다른 사용자로 인식)
3. 클라이언트는 요청 할 때마다 서버에 쿠키를 함께 보낸다 (Http 헤더에 담아서 요청한다.)

### 구성요소
- 이름
- 값
- 유효시간
- 도메인
- 전송경로

### 사용목적
1. 세션관리: 로그인, 사용자, 닉네임, 접속 시간 등등 서버가 알아야 할 정보
2. 개인화: 사용자에 따라서 개인화된 정보 (사용자 맞춤)
3. 트래킹: 사용자의 행동과 패턴을 분석

### 사용 예시
- 쇼핑몰 장바구니
- 팝업창 일주일간 보지않음
- 아이디 비밀번호 저장하시겠습니까? 팝업창
            .
            .
            .

### 사용한계
- 클라이언트당 최대 300개
- 서버 도메인당 최대 20개
- 하나의 쿠키값은 최대 4KB
- 보안에 취약 (임의 수정가능)

### HTTP Only Cookies
- Cookie는 JS로 클라이언트에서 조회가 가능하다.
- JS로 쿠키를 악의적으로 가로채려고 할 수 있으며, 가장 대표적인 것이 XSS(Cross-Site-Scripting) 이다.
  - 해커가 걸어놓은 링크로 이동 시, 쿠키를 탈취 당한다.
- 브라우저에서 Cookie에 접근하는 것을 막음으로써 해결 할 수 있다.
  - ```text
      Set-Cookie: 쿠키명=쿠키값; path=/; HttpOnly
    ```
  - 대부분의 Cookie는 브라우저에서 접근 할 필요가 없다.

### Secure Cookie
- 네트워크를 직접 감청하여 Cookie를 가로챈다.
- HTTPS를 통해서 Cookie또한 암호화 된다.
  - 가로채도 암호화 되어있기 때문에, 데이터를 알 수 없다.
  - **HTTPS에서 Header는 암호화 되어있지 않지만, Cookie의 경우에는 Body에 들어있다.**
- HTTPS가 아니면 Cookie를 전송하지 않는다.
  - ```text
        Set-Cookie: 쿠키명=쿠키값; path=/; secure
    ```


## 세션
- 쿠키를 기반으로 하지만 데이터는 서버측에서 관리
- 브라우저가 종료되거나, Server에서 삭제를 할 땜나 삭제가 된다. (보안 상의 이점)
- 브라우저 당 하나의 SessionID를 발급한다.

### 동작과정
1. 클라이언트가 서버에 접속시 SessionID를 발급받음
2. 클라이언트는 SessionID를 Cookie에 저장함
3. 클라이언트는 요청 할 때마다 서버에 이 SessionID를 같이보냄

### 사용 예시
- 로그인

### 사용한계
- 서버의 자원(DB,메모리 등)을 사용하기 떄문에 무리가 갈 수 있음

### 스티키 세션 (Sticky Session)
- 일반적으로 부하분산을 위해서 로드밸런싱 (LoadBalancing)을 하여 Scale-Out 한 다수의 서버를 운영한다.
- Statless한 REST API 환경에서 Stateful한 작업을 하기위한 방식이다.
- 특정 Session의 요청을 처음에 처리한 서버로 계속해서 요청을 전달하는 방식이다.
    - 쿠키를 사용하거나 IP Tracking을 이용한다.
- 특정 서버에 과부하가 걸리거나, 오류가 나면 세션이 모두 소실될 수 있다.

### 세션 클러스터링 (Session Clustering)
- 분산환경에서 WAS 사이의 세션을 공유하는 기술
- 각 서버의 세션저장소를 Clustring해서 관리하는 것이다.
- 대부분의 WAS에서 해당 기능을 지원한다.
    - Tomcat의 경우 Multicast 방식으로 세션을 공유한다.
- 하나의 저장소에 세션이 생기면 다른 저장소에도 동기화를 해주어야하기 때문에 성능저하가 발생 할 수 있다.


## 쿠키와 세션의 차이

### 저장위치
쿠키는 브라우저 (Client Local), 세션은 서버에 저장된다.

### 보안
쿠키는 탈취와 변조가 가능하지만, 세션은 SessionID만 클라이언트가 가질 수 있기 때문에
보안상으로 상대적으로 안전하다.

## LifeCycle
쿠키는 브라우저가 종료되도 남아있을 수 있지만, 세션은 브라우저 종료 || 서버에서 삭제시 세션 삭제

**노출이되는 데이터는 쿠키로, 노출이 안되는 데이터는 세션**
