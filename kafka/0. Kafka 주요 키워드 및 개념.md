# 0. Kafka 개념 및 이해

## Kafka란?
- Data in Mintion Platform
  - 움직이는 데이터를 처리하는 플랫폼이다. 
- EventStreaming Platform
  - Event가 발생했을 때 Evnet를 필요로 하는 곳으로 데이터를 전달해준다.

### Event란?
- 비즈니스에서 일어나는 모든 일(데이터) 를 의미한다.
- 비즈니스 영역에서 광범위 하게 발생한다.
- Big Data로 발생한다.
  - 많은 Event가 발생하여 Big Data만큼 되기 때문에, EventStream이라고 한다.

### Kafka의 3가지 특징
#### 1. Event Stream을 안전하게 전송
#### 2. EventStream을 Disk에 저장한다.
#### 3. EventStream을 분석 및 처리

### Kafka 주요 사용 사례

#### 1. Messaging System
#### 2. IOT 디바이스로부터 데이터 수집
#### 3. Application에서 발생하는 Log 수집
#### 4. RealTimeEventStreaming Prodcessing (이상감지 등)
#### 5. DB동기화 (MSA 기반의 분리된 DB 동기화)

***

## Message
- 아래와 같은 동의어들이 있다.
  - Record
  - Event
  - Message
  - Data
- Header(MetaData: Topic, Partition, Timestamp ... ), Key, Value로 이루어 진다.
- 직렬화를 통해 ByteArray로 구성된다.

***

## Topic
- Message가 저장되는 저장 장소
- 논리적인 표현 방식이다.
- Producer가 공급하고, Consumer가 소비한다.
  - Producer와 Consumer는 서로를 알지 못한다.
  - Producer와  Consumer는 각자의 속도로 Read와 Write를 수행한다.
- 내부적으로 하나 이상의 Partition으로 구성된다.

### Topic 내의 모든 Message 순서보장
- 복수개의 Partition이 존재하면 순서가 보장되지 않는다.
- 모든 Message순서를 보장하려면, **Partition 1개**만 사용해야 한다.

### Key를 이용한 순서보장
- 동일한 Key는 동일한 Partition에 전달이 된다.
- 순서보장이 필요할 경우, 동일한 Key의 Message를 통해 순서를 보장 할 수 있다.
- **파티션의 개수가 바뀌게되면 Global Relocation이 발생하기 떄문에 SideEffect가 발생할 수 있다.**
***

## Partition
- CommitLog이다.
  - Event들이 추가된다.
  - 추가만 가능하고 변경이 불가능하다.
  - offset이라는 것으로 접근 가능하다.
    - offset은 계속해서 증가한다.
  - Consumer Group끼리는 다른 Offset을 갖는다.`
  - Producer와 Consumer의 Offset 차이를 Comsumer Lag라고 부른다.
- 병렬처리를 위해서 다수의 Partition을 사용한다.
- **Segement**라는 실제 Message가 저장되는 물리 File로 구성된다.
  - 지정된 크기가 커지거나(default 1GB), 오래되면(default 168 시간) 새로운 파일이 생성되고 추가된다.
- partition끼리는 서로 독립적이다.
  - offset 조차도 독립적이다.
- partition에 저장된 파일들은 Immutable하다.
- 고가용성을 위해서 복제(Replica) 한다.
  - 여러 Broker에 분산된다.
- ConsumerGroup내의 하나의 Consumer에 의해서만 사용된다. 

### Key Cardinality
- Message의 Key값의 Hash를 통해서 Partition이 결정된다.
- 균등하게 분포되어있어야지 효율성이 올라간다.
***

## Broker
- Kafka Server라고 불린다. 
- Kafka Cluster를 구성하는 요소이다.
  - 최소 3대이상의 Broker를 사용하는 것을 권장한다.
- Partition에대한 Read, Write를 수행하는 소프트웨어 이다.
- Topic의 Partition 일부를 가지고 있다.
  - 일부분을 갖고있을 뿐, 전체 데이터를 갖고있지 않다.
- 하나의 Broker에만 연결해도 전체 Cluster에 접근 할 수 있다.
  - 하지만 해당 Broker가 장애가 발생하면, 접근 할 곳이 사라지므로 보통 모두 연결한다.

***

## ZooKeeper
- Kafka Broker를 관리하는 소프트웨어 이다.
  - 분산 Configuration 정보 유지
  - 분산 동기화 서비스 제공
  - 네이밍 레지스트리 제공
- 분산작업을 제어하기위해서 Tree형태로 구성되어 있다.
- ZooKeeper 없이는 Kafka는 작동하지 않는다.
  - ZooKeeper를 제외한 버전 출시예정(2022)
- Cluster로 구성된다.
  - ZooKeeper Emsemble 이라고 부른다.  
    - Leader와 Follower로 나뉜다.
    - 홀수로 이루어진다.
    - Quorum(정족수) 알고리즘을 사용한다.

***

## Producer
- Kafka Topic으로 Message를 보내는 어플리케이션
- Serializer로 Message(==Record)를 직렬화 한다.

### 과정
1. Partitioner를 통해서 어느 Partition으로 보낼지 결정한다.
   - key가 있으면 Hash, 없으면 RoundRobin
2. Compress(Optional)을 통해서 Message를 압축한다.
3. RecordAccumulator에서 Message를 모아서 Batch로 전송한다.

***

## Consumer
- Partition에서 Message를 가져와서 사용하는 어플리케이션
  - 순서대로 Read(Poll)를 수행한다.
  - Message를 읽은 위치를 Commit하여 다시 읽는 것을 방지한다.
- 다른 ConsumerGroup에 속한 Consumer들은 서로 연관이 없다.
  - 하나의 Topic에 여러 ConsumerGroup이 동시에 Read할 수 있다.
- 하나의 Consumer가 0개이상의 Partition 사용이 가능하다.

### ConsumerGroup
- 동일한 group.id로 구성된 Consumer들이다.
- ConsumerGroup에 속한 Consumer들은 Partition을 분배하여 Consume한다.
  - ConsumerGroup이 동일한 Consumer는 동시에 Partition에 접근 할 수 없다. 
  - ConsumerGroup에 4개의 Consumer, Topic에 4개의 파티션이 있다면?
    - Consumer : Partition = 1 : 1 

***

## Replication
- 고가용성을 위한 방법이다.
- 미리 원본을 복사한 복제본을 준비하여, 장애가 발생했을 때를 미리 대비한다.

### Partition Replication
- 원본을 Leader Patition, 복제본을 Follower Parition이라고 한다.
- Replication Factor 옵션은 n(원본 + 복제본) 이다.
- Leader Partition을 통해서만 Read와 Write가 진행된다.
  - kafka 2.4 부터는 FollowerParition Read가 가능해졌다.
  - 그렇기 때문에 Leader Parition에 대한 분배가 필요하다.
    - auto.leader.rebalance.enable (default도 enable)
- Follower Partition은 장애가 발생했을 떄를 대비해서 만들어지는 것이다.
  - Follower가 Leader의 CommitLog에서 FetchRequest를 통해서 복제한다.

#### 장애 발생 시
- Follower Partition 중에서 하나가 Leader Partition이 된다.
- Producer와 Consumer들 또한 새롭게 선출된 Leader로 데이터를 포워딩한다.
- Kafka Cluster가 Leader를 선출한다.