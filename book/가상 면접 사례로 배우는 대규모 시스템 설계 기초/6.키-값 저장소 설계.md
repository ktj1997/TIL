# 키-값(Key-Value) 저장소 설계

## Key-Value 저장소란?
- 비관계형(non-relational) 데이터베이스이다.
- 이 저장소에 저장되는 값은 고유식별자를 가져야한다.
  - Key에는 일반 Text 혹은 Hash가 들어간다.
  - Value에는 일반 Text, List, Object 등이 있다.
- Key값은 짧을 수록 성능상 좋다.
- 이러한 Key-Value 쌍(Pair) 관계 때문에 Key-Value 저장소라고 부른다.
- Dynamo, Memcached, Redis 등이 있다.

## CAP정리
- 분산시스템에서 자주 인용되는 개념
- **CAP 세가지의 개념을 모두 만족하는 분산시스템은 설계 불가능 하다는 것이다.**
- 하나의 조건은 희생해야 한다. (두가지만 설계 구현이 가능하다.)
  - CA : 현실 시스템에서 존재하지 않는다.   
  (파티션 감내를 하지 않는다면 분산시스템의 의미가 없다.)
  - CP : 가용성을 희생한다. 
    - 하나의 노드에서 장애가 발생한다면, 나머지 노드들의 쓰기연산 중단 
  - AP : 데이터 일관성을 희생한다.
    - 장애가 복구된 후의 노드는 낡은 데이터를 가지고 있을 것이다.
      (다른 노드들의 쓰기연산을 제한하지 않았기 때문)

### Consistency (데이터 일관성)
분산 시스템에 접속하는 모든 클라이언트는 어떤 노드에 접속했느냐에 관계없이   
일관된 데이터를 얻을 수 있어야 한다.


### Availability (데이터 가용성)
분산 시스템에 접속하는 클라이언트는 일부 노드에 장애가 발생하더라도 항상
응답을 받을 수 있어야 한다.


### Partition Tolerance (파티션 감내)
**파티션: 두 노드 사이에 통신장애가 발생하였음을 의미**   
파티션이 발생하더라도 시스템은 계속해서 동작해야 한다는 의미이다.


## Key-Value 저장소 핵심 용어

### 데이터 파티션
- 데이터를 작은 파티션으로 분할 한 다음에, 여러대의 서버에 저장하는 것
- 두개의 문제가 핵심이다.
   1. 여러개의 노드에 고르게 데이터를 분포 시키는 것.
   2. 노드가 추가되거나 삭제될 때 데이터가 최소한으로 재배치 되는 것.
- 위 문제를 해결하기위해 **안정해시(ConsistentHash)**를 사용한다.

#### 안정해시를 통한 데이터파티션 구축의 장점
1. 확장 자동화 (Auto Scaling): 시스템 부하에 따라 서버가 자동으로 추가되거나 삭제
2. 다양성 (Heterogenity): 각 서버의 용량에 맞게 가상 노드(VirtualNode)의 수를 조절 할 수 있다.

## 데이터 다중화
- 높은 가용성을 위해 다중화(Replication)은 필수적
- 몇개의 서버에 다중화할지 N을 정의해야하는데, N이 대응되는 물리서버의 수와 1:1이 아닐 수 있다.
  - 가상노드를 통해 선택이 될 때, 한개의 서버에 중복 다중화가가능하기 떄문이다.
- 같은 DataCenter에 있는 Node는 네트워크 이슈, 정전 등의 장애를 동시에 겪을 수 있으므로,
  데이터 사본은 다른 DataCenter에 저장하고, DataCenter끼리 고속네트워크로 연결해두어야한다.


## 데이터 일관성
- 여러 노드에 다중화된 데이터는 적절히 동기화 되어야한다.
- 정족수 합의 (Quorum Consensus)프로토콜을 사용하면, 읽기/쓰기 연산 모두에 일관성을 보장 할 수 있다.

### 정족수 합의
- 한 개의 서버에만 보낸다는 의미(x)
- 한 개의 서버로부터 응답을 받으면, 그 이후로는 응답을 기다리지 않음

N = 사본 개수

W = 쓰기 연산에 대한 정족수. 
쓰기 연산이 성공된 것으로 간주되려면, 최소 W개의 서버로 부터 쓰기 연산 성공에 대한 응답을 받아야 한다.

R = 읽기 연산에 대한 정족수.
읽기 연산이 성공된 것으로 간주되려면, 최소 R개의 서버로 부터 읽기 연산 성공에 대한 응답을 받아야 한다.


R = 1, W = N: 빠른 읽기 연산에 최적화된 서비스
W = 1, R = N: 빠른 쓰기 연산에 최적화된 서비스
W + R > N   : 강한 일관성이 보장되는 서비스
W + R <=N   : 강한 일관성이 보장되지 않는 서비스

요구되는 일관성 수준에 따라서 W,R,N 값을 조정하면 된다.

### 일관성 모델

#### 1. 강한 일관성 (Strong Consistency)
- 가용성이 떨어지는 방법
- 모든 읽기연산은 최신의 데이터를 가진다. 
- 모든 사본에 현재 쓰기연산이 반영될 때 까지, 읽기연산을 금지하는 것

#### 2. 약한 일관성 (Weak Consistency)
- 읽기 연산이 최신의 데이터를 반환하지 못할 수도 있다.

#### 3. 최종 일관성 (Eventual Consistency)
- 동시성은 제공(x)
- Dynamo, Cassandra,S3 가 제공하는 일관성 모델
- 일관성이 깨지는 문제는 클라이언트가 해결해야 한다.
- 약한 일관성의 한 형태, 갱신결과가 결국에는 모든 사본에 반영되는 모델
